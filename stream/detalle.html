<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalles</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: sans-serif;
      padding: 1rem;
      max-width: 700px;
      margin: auto;
    }
    img {
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    h1 {
      font-size: 1.5rem;
    }
    p {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .actions button {
      margin-top: 1rem;
      background: #ff5c5c;
      color: white;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="content">Cargando...</div>

  <script>
    const TMDB_API = "6f712d2bf184acc19c28200f263b5220";
    const WATCHMODE_API = "FKEtVUe2E8fwCj420sJfpR7jMKkhUBH7ENQ8SNOX";

    async function buscarTMDB(title) {
      const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API}&query=${encodeURIComponent(title)}&language=es-MX`);
      const data = await res.json();
      return data.results?.[0] || null;
    }

    async function buscarWatchmode(title) {
      const res = await fetch(`https://api.watchmode.com/v1/search/?apiKey=${WATCHMODE_API}&search_value=${encodeURIComponent(title)}&search_field=name`);
      const data = await res.json();
      return data.title_results?.[0]?.id || null;
    }

    async function buscarFuentesWatchmode(id) {
      const res = await fetch(`https://api.watchmode.com/v1/title/${id}/sources/?apiKey=${WATCHMODE_API}`);
      return await res.json();
    }

    async function cargarDetalles() {
      const params = new URLSearchParams(location.search);
      const title = params.get("title");
      const content = document.getElementById("content");

      if (!title) {
        content.innerHTML = "<p>Título no especificado</p>";
        return;
      }

      const tmdb = await buscarTMDB(title);
      if (!tmdb) {
        content.innerHTML = "<p>No se encontró el título en TMDB.</p>";
        return;
      }

      const img = tmdb.poster_path ? `https://image.tmdb.org/t/p/w500${tmdb.poster_path}` : "";
      const sinopsis = tmdb.overview || "Sinopsis no disponible";
      const año = (tmdb.release_date || tmdb.first_air_date || "").split("-")[0] || "Desconocido";
      const tipo = tmdb.media_type === "movie" ? "Película" : "Serie";

      let fuenteHTML = "<p><strong>Plataformas:</strong> No disponibles</p>";
      const watchmodeId = await buscarWatchmode(title);
      if (watchmodeId) {
        const fuentes = await buscarFuentesWatchmode(watchmodeId);
        const urls = fuentes.filter(f => ['subscription'].includes(f.type));
        if (urls.length > 0) {
          fuenteHTML = "<p><strong>Disponible en:</strong></p><ul>" + urls.map(f => `<li><a href="${f.web_url}" target="_blank">${f.name}</a></li>`).join("") + "</ul>";
        }
      }

      content.innerHTML = `
        <img src="${img}" alt="${title}">
        <h1>${title}</h1>
        <p><strong>Tipo:</strong> ${tipo}</p>
        <p><strong>Año:</strong> ${año}</p>
        <p><strong>Sinopsis:</strong> ${sinopsis}</p>
        ${fuenteHTML}
        <div class="actions">
          <button onclick="window.open('https://wa.me/?text=Estoy viendo ${encodeURIComponent(title)}', '_blank')">Compartir</button>
        </div>
      `;
    }

    cargarDetalles();
  </script>
</body>
</html>
